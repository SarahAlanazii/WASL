@model Wasl.ViewModels.CompanyVMs.CompanyBidsViewModel
@{
    ViewData["Title"] = "Bids Waiting for Contracts - Wasl Logistics";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-title-box d-flex align-items-center justify-content-between">
                <h4 class="mb-0">Bids Waiting for Contracts</h4>
                <div class="page-title-right">
                    <span class="badge bg-warning">@Model.Bids.Count bids waiting</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" asp-action="WaitingContracts">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Filter by Shipment</label>
                        <select class="form-select" name="shipment_id">
                            <option value="all">All Shipments</option>
                            @foreach (var shipment in Model.Shipments)
                            {
                                <option value="@shipment.ShipmentRequestId"
                                        selected=" @(Context.Request.Query["shipment_id"] == shipment.ShipmentRequestId.ToString() ? "selected" : "")">
                                    #@shipment.ShipmentRequestId - @shipment.GoodsType
                                </option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                    </div>
                    <div class="col-md-2">
                        <a asp-action="WaitingContracts" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        @if (Model.Bids.Any())
        {
            foreach (var bid in Model.Bids)
            {
                <div class="col-xl-4 col-lg-4 mb-4">
                    <div class="card bid-waiting-card h-100">
                        <div class="card-header bg-warning bg-opacity-10">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title mb-1">Accepted Bid #@bid.BidId</h5>
                                    <p class="text-warning mb-0">
                                        <i class="bi bi-clock"></i> Waiting for Contract Creation
                                    </p>
                                </div>
                                <span class="badge bg-warning">Action Required</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Provider Info -->
                            <div class="d-flex align-items-center mb-3">
                                <div class="flex-shrink-0">
                                    <div class="avatar-md bg-light-primary rounded-circle d-flex align-items-center justify-content-center">
                                        <i class="bi bi-building font-18 text-primary"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">@bid.Provider?.ProviderName</h6>
                                    <small class="text-muted">@bid.Provider?.ProviderCity</small>
                                    <div class="mt-1">
                                        @{
                                            var avgRating = bid.Provider?.Feedbacks?.Average(f => f.Rating ?? 0) ?? 0;
                                            var ratingCount = bid.Provider?.Feedbacks?.Count ?? 0;
                                        }
                                        <div class="star-rating small">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="bi bi-star@(i <= avgRating ? "-fill" : "") text-warning"></i>
                                            }
                                        </div>
                                        <small class="text-muted">(@ratingCount reviews)</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Shipment Info -->
                            <div class="mb-4">
                                <h6 class="text-primary mb-2">
                                    <i class="bi bi-box-seam me-2"></i>
                                    Shipment #@bid.ShipmentRequest?.ShipmentRequestId
                                </h6>
                                <p class="mb-1"><strong>Goods:</strong> @bid.ShipmentRequest?.GoodsType</p>
                                <p class="mb-1">
                                    <strong>Route:</strong>
                                    @bid.ShipmentRequest?.PickupCity → @bid.ShipmentRequest?.DeliveryCity
                                </p>
                                <p class="mb-0">
                                    <strong>Weight:</strong> @bid.ShipmentRequest?.WeightKg kg
                                </p>
                            </div>

                            <!-- Bid Details -->
                            <div class="border-top pt-3">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <h4 class="text-success mb-1">SAR @((bid.BidPrice ?? 0).ToString("N2"))</h4>
                                        <small class="text-muted">Bid Price</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-info mb-1">@bid.EstimatedDeliveryDays</h4>
                                        <small class="text-muted">Delivery Days</small>
                                    </div>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(bid.BidNotes))
                            {
                                <div class="mt-3 p-3 bg-light rounded">
                                    <h6 class="mb-2">Provider Notes:</h6>
                                    <p class="mb-0 text-muted">@bid.BidNotes</p>
                                </div>
                            }
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-grid gap-2">
                                <button type="button"
                                        class="btn btn-primary create-contract-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#createContractModal"
                                        data-bid-id="@bid.BidId"
                                        data-provider-name="@bid.Provider?.ProviderName"
                                        data-bid-price="@bid.BidPrice">
                                    <i class="bi bi-file-text me-2"></i> Create Contract
                                </button>
                                <a asp-controller="CompanyBid" asp-action="Show" asp-route-id="@bid.BidId"
                                   class="btn btn-outline-secondary">
                                    <i class="bi bi-eye me-2"></i> View Bid Details
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="empty-state text-center py-5">
                            <i class="bi bi-check-circle display-4 text-success d-block mb-3"></i>
                            <h4>All Caught Up!</h4>
                            <p class="text-muted mb-4">No bids are waiting for contract creation. All accepted bids have contracts.</p>
                            <a asp-controller="CompanyBid" asp-action="Index" class="btn btn-primary">
                                <i class="bi bi-file-text me-2"></i> View All Bids
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Create Contract Modal -->
<div class="modal fade" id="createContractModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Contract</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createContractForm" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div id="contractModalContent">
                        <!-- Contract details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitContractBtn">
                        <i class="bi bi-save me-2"></i> Create Contract
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .bid-waiting-card {
            border-left: 4px solid var(--warning);
            transition: all 0.3s ease;
        }

            .bid-waiting-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

        .star-rating {
            font-size: 0.9rem;
        }

            .star-rating.small {
                font-size: 0.8rem;
            }

        .avatar-md {
            width: 50px;
            height: 50px;
        }

        .contract-preview {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #eef2f7;
            border-radius: 8px;
            background: #f8f9fa;
        }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const createContractModal = document.getElementById('createContractModal');
            const contractModalContent = document.getElementById('contractModalContent');
            const createContractForm = document.getElementById('createContractForm');
            const submitContractBtn = document.getElementById('submitContractBtn');

            // Handle create contract button clicks
            document.querySelectorAll('.create-contract-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bidId = this.getAttribute('data-bid-id');
                    const providerName = this.getAttribute('data-provider-name');
                    const bidPrice = this.getAttribute('data-bid-price');

                    // Set form action
                    createContractForm.action = `/Company/CompanyContract/CreateContract?bidId=${bidId}`;

                    // Load contract creation form
                    contractModalContent.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            You are creating a contract for <strong>${providerName}</strong> with bid amount <strong>SAR ${parseFloat(bidPrice).toFixed(2)}</strong>.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contract Document <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="contractDocument" accept=".pdf,.doc,.docx" required>
                            <div class="form-text">
                                Upload the contract document (PDF, DOC, DOCX) - Max 10MB
                            </div>
                        </div>
                        <div class="contract-preview">
                            <h6>Contract Preview:</h6>
                            <p><strong>Parties:</strong> Your Company & ${providerName}</p>
                            <p><strong>Service:</strong> Logistics transportation services</p>
                            <p><strong>Amount:</strong> SAR ${parseFloat(bidPrice).toFixed(2)}</p>
                            <p><strong>Status:</strong> Waiting for provider signature</p>
                            <p class="text-muted small">
                                Once created, the contract will be sent to the provider for signature.
                                After provider signs, you can proceed with payment.
                            </p>
                        </div>
                    `;
                });
            });

            // Handle form submission
            createContractForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const submitBtn = submitContractBtn;

                // Disable button and show loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> Creating Contract...';

                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.showSuccessToast(data.message);
                        setTimeout(() => {
                            window.location.href = '/Company/CompanyContract/Index';
                        }, 1500);
                    } else {
                        window.showErrorToast(data.message || 'Failed to create contract');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-save me-2"></i> Create Contract';
                    }
                })
                .catch(error => {
                    window.showErrorToast('An error occurred. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-save me-2"></i> Create Contract';
                });
            });

            // Clear modal when hidden
            createContractModal.addEventListener('hidden.bs.modal', function() {
                contractModalContent.innerHTML = '';
                createContractForm.reset();
                submitContractBtn.disabled = false;
                submitContractBtn.innerHTML = '<i class="bi bi-save me-2"></i> Create Contract';
            });
        });
    </script>
}